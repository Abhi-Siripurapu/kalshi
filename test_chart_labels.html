<!DOCTYPE html>
<html>
<head>
    <title>Chart Labels Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #chart-container { width: 800px; height: 400px; margin: 20px 0; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>Chart Labels Fix Test</h2>
    
    <button onclick="testChart()">Load Chart with Fixed Labels</button>
    
    <div id="chart-container">
        <canvas id="price-chart"></canvas>
    </div>
    
    <div id="debug" class="debug">Click button to test...</div>
    
    <script>
        let priceChart = null;
        const API_BASE = 'http://localhost:8000';
        
        async function testChart() {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = 'Loading chart data...';
            
            try {
                const marketsResponse = await fetch(`${API_BASE}/markets?limit=1`);
                const marketsData = await marketsResponse.json();
                const ticker = marketsData.markets[0].ticker;
                
                const response = await fetch(`${API_BASE}/market/${ticker}/candlesticks?period_interval=60&start_days_ago=7`);
                const data = await response.json();
                
                debugEl.innerHTML += `<br>Candlesticks: ${data.candlesticks?.length || 0}`;
                
                if (data.candlesticks && data.candlesticks.length > 0) {
                    createImprovedChart(data.candlesticks, ticker, debugEl);
                } else {
                    debugEl.innerHTML += '<br>❌ No candlestick data';
                }
                
            } catch (err) {
                debugEl.innerHTML += `<br>❌ Error: ${err.message}`;
            }
        }
        
        function createImprovedChart(candlesticks, ticker, debugEl) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Better label processing with time granularity
            const labels = candlesticks.map((candle, index) => {
                const timestamp = candle.end_period_ts || candle.ts;
                
                if (timestamp) {
                    const dateMs = timestamp > 1000000000000 ? timestamp : timestamp * 1000;
                    const date = new Date(dateMs);
                    
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                        // For hourly data, show both date and time
                        const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        const dateStr = date.toLocaleDateString();
                        return `${dateStr} ${timeStr}`;
                    }
                }
                
                // Improved fallback with actual time spacing
                const now = new Date();
                const hoursAgo = (candlesticks.length - index - 1);
                const fallbackTime = new Date(now.getTime() - (hoursAgo * 60 * 60 * 1000));
                const timeStr = fallbackTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                const dateStr = fallbackTime.toLocaleDateString();
                return `${dateStr} ${timeStr}`;
            });
            
            // Extract prices
            const prices = candlesticks.map(candle => {
                if (candle.close !== undefined) {
                    return candle.close;
                } else if (candle.price && candle.price.close !== null) {
                    return candle.price.close;
                } else if (candle.yes_bid && candle.yes_ask) {
                    const bid = candle.yes_bid.close || candle.yes_bid.open;
                    const ask = candle.yes_ask.close || candle.yes_ask.open;
                    return Math.round((bid + ask) / 2);
                }
                return 0;
            });
            
            // Extract volumes
            const volumes = candlesticks.map(candle => candle.volume || 0);
            
            debugEl.innerHTML += `<br>Labels: ${labels.join(', ')}`;
            debugEl.innerHTML += `<br>Prices: ${prices.join(', ')}`;
            debugEl.innerHTML += `<br>Volumes: ${volumes.join(', ')}`;
            
            // Create chart with both price and volume
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (¢)',
                        data: prices,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Volume',
                        data: volumes,
                        type: 'bar',
                        backgroundColor: 'rgba(99, 102, 241, 0.3)',
                        borderColor: 'rgba(99, 102, 241, 0.8)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${ticker} - Price & Volume (${candlesticks.length} periods)`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Price (¢)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '¢';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Volume'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>