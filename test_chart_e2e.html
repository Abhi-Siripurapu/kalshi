<!DOCTYPE html>
<html>
<head>
    <title>End-to-End Chart Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #chart-container { width: 800px; height: 400px; margin: 20px 0; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>End-to-End Chart Test</h2>
    
    <button onclick="testChart()">Load Real Candlestick Chart</button>
    
    <div id="chart-container">
        <canvas id="price-chart"></canvas>
    </div>
    
    <div id="debug" class="debug">Click button to test...</div>
    
    <script>
        let priceChart = null;
        const API_BASE = 'http://localhost:8000';
        
        async function testChart() {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = 'Loading chart data...';
            
            try {
                // Get first market
                const marketsResponse = await fetch(`${API_BASE}/markets?limit=1`);
                const marketsData = await marketsResponse.json();
                const ticker = marketsData.markets[0].ticker;
                
                debugEl.innerHTML += `<br>Testing with ticker: ${ticker}`;
                
                // Get candlestick data
                const response = await fetch(`${API_BASE}/market/${ticker}/candlesticks?period_interval=60&start_days_ago=7`);
                const data = await response.json();
                
                debugEl.innerHTML += `<br>Candlesticks received: ${data.candlesticks?.length || 0}`;
                
                if (data.candlesticks && data.candlesticks.length > 0) {
                    debugEl.innerHTML += '<br>Creating chart...';
                    createPriceChart(data.candlesticks, ticker);
                    debugEl.innerHTML += '<br>✅ Chart created successfully!';
                } else {
                    debugEl.innerHTML += '<br>❌ No candlestick data available';
                }
                
            } catch (err) {
                debugEl.innerHTML += `<br>❌ Error: ${err.message}`;
                console.error(err);
            }
        }
        
        function createPriceChart(candlesticks, ticker) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            
            // Destroy existing chart
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Process labels (dates)
            const labels = candlesticks.map((candle, index) => {
                const timestamp = candle.end_period_ts || candle.ts;
                
                if (timestamp) {
                    const dateMs = timestamp > 1000000000000 ? timestamp : timestamp * 1000;
                    const date = new Date(dateMs);
                    
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                        return date.toLocaleDateString();
                    }
                }
                
                // Fallback
                const hoursAgo = (candlesticks.length - index - 1);
                const fallbackTime = new Date(Date.now() - (hoursAgo * 60 * 60 * 1000));
                return fallbackTime.toLocaleDateString();
            });
            
            // Process prices
            const prices = candlesticks.map(candle => {
                if (candle.close !== undefined) {
                    return candle.close;
                } else if (candle.price && candle.price.close !== null) {
                    return candle.price.close;
                } else if (candle.yes_bid && candle.yes_ask) {
                    const bid = candle.yes_bid.close || candle.yes_bid.open;
                    const ask = candle.yes_ask.close || candle.yes_ask.open;
                    return Math.round((bid + ask) / 2);
                }
                return 0;
            });
            
            console.log('Chart data:', { labels, prices });
            
            // Create chart
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (¢)',
                        data: prices,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${ticker} - Price Chart`
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '¢';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>