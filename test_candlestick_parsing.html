<!DOCTYPE html>
<html>
<head>
    <title>Candlestick Data Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Candlestick Data Parsing Test</h2>
    <canvas id="test-chart" width="400" height="200"></canvas>
    
    <div id="debug-output"></div>
    
    <script>
        // Sample Kalshi candlestick data from our API
        const sampleData = [
            {
                "end_period_ts": 1755349200,
                "yes_bid": {"open": 4, "low": 4, "high": 37, "close": 36},
                "yes_ask": {"open": 100, "low": 38, "high": 100, "close": 38},
                "price": {"open": 39, "low": 38, "high": 39, "close": 38, "mean": 38},
                "volume": 875
            },
            {
                "end_period_ts": 1755352800,
                "yes_bid": {"open": 36, "low": 36, "high": 36, "close": 36},
                "yes_ask": {"open": 38, "low": 38, "high": 39, "close": 38},
                "price": {"open": 38, "low": 38, "high": 38, "close": 38, "mean": 38},
                "volume": 38
            }
        ];
        
        // Test date parsing
        console.log("Testing date parsing:");
        const labels = sampleData.map(candle => {
            const timestamp = candle.end_period_ts || candle.ts;
            console.log(`Raw timestamp: ${timestamp}`);
            
            // Handle both seconds and milliseconds timestamps
            const dateMs = timestamp > 1000000000000 ? timestamp : timestamp * 1000;
            const date = new Date(dateMs);
            console.log(`Date object: ${date}`);
            console.log(`Year: ${date.getFullYear()}`);
            
            // Check if date is valid and not too far in the future
            if (isNaN(date.getTime()) || date.getFullYear() > 2026) {
                console.log("Invalid date, using current time");
                return new Date().toLocaleDateString();
            }
            
            return date.toLocaleDateString();
        });
        
        console.log("Labels:", labels);
        
        // Test price extraction
        console.log("Testing price extraction:");
        const prices = sampleData.map(candle => {
            if (candle.close !== undefined) {
                // Mock data format
                console.log(`Mock format close: ${candle.close}`);
                return candle.close;
            } else if (candle.price && candle.price.close !== null) {
                // Real Kalshi data - actual trade price
                console.log(`Real Kalshi price.close: ${candle.price.close}`);
                return candle.price.close;
            } else if (candle.yes_bid && candle.yes_ask) {
                // Real Kalshi data - mid-price between bid and ask
                const bid = candle.yes_bid.close || candle.yes_bid.open;
                const ask = candle.yes_ask.close || candle.yes_ask.open;
                const midPrice = Math.round((bid + ask) / 2);
                console.log(`Mid-price calculation: bid=${bid}, ask=${ask}, mid=${midPrice}`);
                return midPrice;
            }
            return 0;
        });
        
        console.log("Prices:", prices);
        
        // Create test chart
        const ctx = document.getElementById('test-chart').getContext('2d');
        const testChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price (Â¢)',
                    data: prices,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Test Chart - Candlestick Data Parsing'
                    }
                }
            }
        });
        
        // Output debug info
        document.getElementById('debug-output').innerHTML = `
            <h3>Debug Info:</h3>
            <p><strong>Labels:</strong> ${labels.join(', ')}</p>
            <p><strong>Prices:</strong> ${prices.join(', ')}</p>
            <p><strong>Chart created:</strong> ${testChart ? 'Yes' : 'No'}</p>
        `;
    </script>
</body>
</html>