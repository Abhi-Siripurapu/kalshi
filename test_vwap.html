<!DOCTYPE html>
<html>
<head>
    <title>VWAP Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0f172a; color: #f1f5f9; }
        #chart-container { width: 800px; height: 400px; margin: 20px 0; }
        .debug { background: #1e293b; padding: 10px; margin: 10px 0; border-radius: 6px; }
    </style>
</head>
<body>
    <h2>VWAP (Volume Weighted Average Price) Test</h2>
    
    <button onclick="testVWAP()">Calculate VWAP</button>
    
    <div id="chart-container">
        <canvas id="price-chart"></canvas>
    </div>
    
    <div id="debug" class="debug">Click button to test VWAP calculation...</div>
    
    <script>
        let priceChart = null;
        const API_BASE = 'http://localhost:8000';
        
        function calculateVWAP(candlesticks) {
            let cumulativeVolumePrice = 0;
            let cumulativeVolume = 0;
            const vwapData = [];
            
            for (let i = 0; i < candlesticks.length; i++) {
                const candle = candlesticks[i];
                
                // Get typical price (average of high, low, close)
                let typicalPrice;
                if (candle.price && candle.price.high !== null) {
                    // Real Kalshi data
                    const high = candle.price.high || candle.price.close;
                    const low = candle.price.low || candle.price.close;
                    const close = candle.price.close;
                    typicalPrice = (high + low + close) / 3;
                } else if (candle.yes_bid && candle.yes_ask) {
                    // Fallback to mid-price
                    const bid = candle.yes_bid.close || candle.yes_bid.open;
                    const ask = candle.yes_ask.close || candle.yes_ask.open;
                    typicalPrice = (bid + ask) / 2;
                } else {
                    typicalPrice = candle.close || 50; // Mock data fallback
                }
                
                const volume = candle.volume || 0;
                
                // Accumulate volume * price and volume
                cumulativeVolumePrice += typicalPrice * volume;
                cumulativeVolume += volume;
                
                // Calculate VWAP
                const vwap = cumulativeVolume > 0 ? cumulativeVolumePrice / cumulativeVolume : typicalPrice;
                vwapData.push(vwap);
            }
            
            return vwapData;
        }
        
        async function testVWAP() {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = 'Loading data for VWAP calculation...';
            
            try {
                // Get market data
                const marketsResponse = await fetch(`${API_BASE}/markets?limit=1`);
                const marketsData = await marketsResponse.json();
                const ticker = marketsData.markets[0].ticker;
                
                // Get candlestick data
                const candleResponse = await fetch(`${API_BASE}/market/${ticker}/candlesticks?period_interval=60&start_days_ago=7`);
                const candleData = await candleResponse.json();
                
                debugEl.innerHTML = `Market: ${ticker}`;
                
                if (candleData.candlesticks && candleData.candlesticks.length > 0) {
                    const candlesticks = candleData.candlesticks;
                    const vwapData = calculateVWAP(candlesticks);
                    
                    debugEl.innerHTML += `<br>VWAP calculated for ${candlesticks.length} periods`;
                    debugEl.innerHTML += `<br>Final VWAP: ${vwapData[vwapData.length - 1].toFixed(2)}¢`;
                    
                    createVWAPChart(candlesticks, vwapData, ticker);
                    debugEl.innerHTML += '<br>✅ VWAP chart created!';
                } else {
                    debugEl.innerHTML += '<br>❌ No candlestick data';
                }
                
            } catch (err) {
                debugEl.innerHTML += `<br>❌ Error: ${err.message}`;
            }
        }
        
        function createVWAPChart(candlesticks, vwapData, ticker) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Process labels and prices
            const labels = candlesticks.map((candle, index) => {
                const timestamp = candle.end_period_ts || candle.ts;
                if (timestamp) {
                    const date = new Date(timestamp * 1000);
                    if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                        return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    }
                }
                return `T-${candlesticks.length - index - 1}h`;
            });
            
            const prices = candlesticks.map(candle => {
                if (candle.price && candle.price.close !== null) {
                    return candle.price.close;
                } else if (candle.yes_bid && candle.yes_ask) {
                    const bid = candle.yes_bid.close || candle.yes_bid.open;
                    const ask = candle.yes_ask.close || candle.yes_ask.open;
                    return Math.round((bid + ask) / 2);
                }
                return 0;
            });
            
            const volumes = candlesticks.map(candle => candle.volume || 0);
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (¢)',
                        data: prices,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'VWAP (¢)',
                        data: vwapData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Volume',
                        data: volumes,
                        type: 'bar',
                        backgroundColor: 'rgba(99, 102, 241, 0.3)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${ticker} - Price vs VWAP`,
                            color: '#f1f5f9'
                        },
                        legend: {
                            labels: {
                                color: '#f1f5f9'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: '#334155' },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value.toFixed(1) + '¢';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Price (¢)',
                                color: '#94a3b8'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#94a3b8' },
                            title: {
                                display: true,
                                text: 'Volume',
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>