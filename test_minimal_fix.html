<!DOCTYPE html>
<html>
<head>
    <title>Minimal Fix Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0f172a; color: #f1f5f9; }
        .debug { background: #1e293b; padding: 10px; margin: 10px 0; border-radius: 6px; }
        button { background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        canvas { background: #1e293b; }
    </style>
</head>
<body>
    <h2>Minimal Chart Test</h2>
    
    <button onclick="testBasicChart()">Test Basic Chart</button>
    <button onclick="testVWAPChart()">Test VWAP Chart</button>
    
    <div style="width: 600px; height: 300px; margin: 20px 0;">
        <canvas id="test-chart"></canvas>
    </div>
    
    <div id="debug" class="debug">Ready to test...</div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        let testChart = null;
        
        async function testBasicChart() {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = 'Testing basic chart creation...';
            
            try {
                // Get real data
                const marketsResponse = await fetch(`${API_BASE}/markets?limit=1`);
                const marketsData = await marketsResponse.json();
                const ticker = marketsData.markets[0].ticker;
                
                const candleResponse = await fetch(`${API_BASE}/market/${ticker}/candlesticks?period_interval=60&start_days_ago=7`);
                const candleData = await candleResponse.json();
                
                if (candleData.candlesticks && candleData.candlesticks.length > 0) {
                    const candlesticks = candleData.candlesticks;
                    
                    // Simple chart without all the analytics
                    const labels = candlesticks.map((candle, index) => `Period ${index + 1}`);
                    const prices = candlesticks.map(candle => {
                        if (candle.price && candle.price.close !== null) {
                            return candle.price.close;
                        }
                        return 50; // fallback
                    });
                    
                    const ctx = document.getElementById('test-chart').getContext('2d');
                    
                    if (testChart) {
                        testChart.destroy();
                    }
                    
                    testChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Price (¢)',
                                data: prices,
                                borderColor: '#10b981',
                                borderWidth: 2,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${ticker} - Basic Chart`,
                                    color: '#f1f5f9'
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        color: '#94a3b8',
                                        callback: function(value) {
                                            return value + '¢';
                                        }
                                    }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                    
                    debugEl.innerHTML += `<br>✅ Basic chart created with ${prices.length} data points`;
                    debugEl.innerHTML += `<br>Prices: ${prices.join(', ')}`;
                    
                } else {
                    debugEl.innerHTML += '<br>❌ No candlestick data available';
                }
                
            } catch (err) {
                debugEl.innerHTML += `<br>❌ Error: ${err.message}`;
                console.error('Chart test error:', err);
            }
        }
        
        async function testVWAPChart() {
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = 'Testing VWAP calculation...';
            
            try {
                // Get real data
                const marketsResponse = await fetch(`${API_BASE}/markets?limit=1`);
                const marketsData = await marketsResponse.json();
                const ticker = marketsData.markets[0].ticker;
                
                const candleResponse = await fetch(`${API_BASE}/market/${ticker}/candlesticks?period_interval=60&start_days_ago=7`);
                const candleData = await candleResponse.json();
                
                if (candleData.candlesticks && candleData.candlesticks.length > 0) {
                    const candlesticks = candleData.candlesticks;
                    
                    // Test VWAP calculation
                    const vwapData = calculateVWAP(candlesticks);
                    debugEl.innerHTML += `<br>✅ VWAP calculation completed: ${vwapData.length} points`;
                    debugEl.innerHTML += `<br>VWAP values: ${vwapData.map(v => v.toFixed(1)).join(', ')}`;
                    
                    // Test price movement detection
                    const movements = detectPriceMovements(candlesticks);
                    debugEl.innerHTML += `<br>✅ Movement detection: ${movements.alerts.length} alerts`;
                    
                    if (movements.alerts.length > 0) {
                        debugEl.innerHTML += `<br>Alerts: ${movements.alerts.map(a => a.message).join(', ')}`;
                    }
                    
                } else {
                    debugEl.innerHTML += '<br>❌ No candlestick data for VWAP test';
                }
                
            } catch (err) {
                debugEl.innerHTML += `<br>❌ VWAP test error: ${err.message}`;
                console.error('VWAP test error:', err);
            }
        }
        
        // Copy analytics functions for testing
        function calculateVWAP(candlesticks) {
            let cumulativeVolumePrice = 0;
            let cumulativeVolume = 0;
            const vwapData = [];
            
            for (let i = 0; i < candlesticks.length; i++) {
                const candle = candlesticks[i];
                
                let typicalPrice;
                if (candle.price && candle.price.high !== null) {
                    const high = candle.price.high || candle.price.close;
                    const low = candle.price.low || candle.price.close;
                    const close = candle.price.close;
                    typicalPrice = (high + low + close) / 3;
                } else if (candle.yes_bid && candle.yes_ask) {
                    const bid = candle.yes_bid.close || candle.yes_bid.open;
                    const ask = candle.yes_ask.close || candle.yes_ask.open;
                    typicalPrice = (bid + ask) / 2;
                } else {
                    typicalPrice = candle.close || 50;
                }
                
                const volume = candle.volume || 1; // Avoid division by zero
                
                cumulativeVolumePrice += typicalPrice * volume;
                cumulativeVolume += volume;
                
                const vwap = cumulativeVolume > 0 ? cumulativeVolumePrice / cumulativeVolume : typicalPrice;
                vwapData.push(vwap);
            }
            
            return vwapData;
        }
        
        function detectPriceMovements(candlesticks) {
            const movements = [];
            const alerts = [];
            
            for (let i = 1; i < candlesticks.length; i++) {
                const current = candlesticks[i];
                const previous = candlesticks[i - 1];
                
                let currentPrice, previousPrice;
                
                if (current.price && current.price.close !== null) {
                    currentPrice = current.price.close;
                } else {
                    currentPrice = 50;
                }
                
                if (previous.price && previous.price.close !== null) {
                    previousPrice = previous.price.close;
                } else {
                    previousPrice = 50;
                }
                
                const priceChange = currentPrice - previousPrice;
                const percentChange = previousPrice > 0 ? (priceChange / previousPrice) * 100 : 0;
                
                if (Math.abs(percentChange) >= 2) {
                    alerts.push({
                        type: percentChange > 0 ? 'spike' : 'drop',
                        message: `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'surge' : 'drop'}`,
                        details: `${previousPrice.toFixed(1)}¢ → ${currentPrice.toFixed(1)}¢`
                    });
                }
            }
            
            return { movements, alerts };
        }
    </script>
</body>
</html>